var e=Object.defineProperty,a=Object.defineProperties,t=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,l=(a,t,r)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):a[t]=r,i=(e,a)=>{for(var t in a||(a={}))n.call(a,t)&&l(e,t,a[t]);if(r)for(var t of r(a))s.call(a,t)&&l(e,t,a[t]);return e};import{d as c,g as o,j as d,r as g,ad as h,D as v,o as A,y as m,t as u,a1 as w,N as f,_ as p,J as x,a as y,W as C,B as I,b as L,n as D,f as B,w as R,M as P,e as F,q as E,C as b,F as S,z as Y,v as j,h as H,Y as U,p as k,i as M}from"./index-957d2311.js";import{a as O}from"./axios-c1c8d626.js";import{u as J}from"./index.esm-9d210ab7.js";import{W as N}from"./worker-826c696b.js";import{_ as T}from"./plugin-vue_export-helper-46f75680.js";var X=c({name:"preview",components:{},props:{},emits:[],setup(e,r){const{proxy:n}=o(),s=d();let l=g({projectData:h(),emptyColor:"#00000000",bgCanvas:null,canvas:null,realCanvas:null,ctx1:null,ctx2:null,ctx3:null,isDrawing:!1,isErasering:!1,isDrawShape:!1,isMoving:!1,isSelecting:!1,isCopy:!1,isScale:!1,shapeFillColor:"#000000ff",brushColor:"#000000ff",brushSize:1,eraserSize:1,canvasWidth:32,canvasHeight:32,scale:1,isCheckedRatio:!0,isShowReferenceLine:!1,widthHeightRatio:1,drawAreaList:[],currentTool:0,drawRecord:[],drawShapeList:[],gridInfo:"[]",myColorList:n.$config.colorList,myColor:"#ffffffff",myColorGroup:1,isAddGroup:!1,myGroupName:"",addMyColorVisible:!1,editMyColorMask:null,currentDrawShape:"rect",currentDrawTransform:"hReverse",historyRecord:[],historyMaxLength:10,currentHistoryIndex:0,historyTimer:null,lastX:0,lastY:0,currentFrameIndex:0,currentLayerIndex:0,currentFrameId:0,currentLayerId:0,currentFrameLayerVisible:!0,currentEditLayer:{index:-1,name:""},FrameTimer:null,maxFrame:12,maxLayer:30,exportVisible:!1,exportLoaidng:!1,loading:!1,isSpace:!1,isShift:!1,isDragging:!1,dragData:{x:0,y:0},canvasBeginPos:{x:0,y:0,centerX:0,centerY:0},moveData:{x:0,y:0,centerX:0,centerY:0,list:[]},selectData:{selectLayerId:0,x:-1,y:-1,originList:[],selectList:[],copyList:[]},selectType:"select",previewLoading:!1,selectActiveColor:"#3c8bfb8f",isExpandColorSelector:!0,colorStatList:[],worker:null,isExportProject:!1,AnimationFrameId_1:null,zIndex:{max:13,min:8},isSaveProject:!0,pinDouMode:!1,pinDouDrawMode:!1,pinDouData:null,tolerance:0,curvature:4,curveType:{isPress:!1,pressKey:"0"},curveEndPos:[],isHorizontal:!1,isVertical:!1,isCenter:!1,drawList:[],removeDrawList:[],LayerMenu:{visible:!1,top:0,left:0,contextData:null},selectLayerList:[],pindouHighlight:null,isHidePindouMode:!1,pindouBrand:"mard",isScaling:!1,scaleWhitePointPos:[],scaleAreaData:null,scaleRatio:0,emptyLayerData:[],exportStyleOptions:{isShowGrid:!1,gridBackgroundColor:"#ffffffff"},layerAlpha:100,isHideLinmoMode:!1,linmoMode:!1,linmoPhoto:null,linmoPhotoStyle:{transform:"translate(0px, 0px) rotate(0deg) scale(1, 1)",opacity:1,zIndex:0,display:"block"},linmoPhotoDom:null,dragLinmoPhoto:{enable:!1,startX:0,startY:0,translateX:0,translateY:0},scaleTimer:null,loadingText:"正在加载项目..."});const c={requireVisibleImg:v((()=>e=>e?s.themeValue?new URL("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAAwNJREFUeF7tmU2IjVEYx3//nYViJRbKCgtfxQIpasosDLFgMTGUMmQlWVGULdn5mJKPSWpmQUhRsvAxKVOSUjYsJsXKwsJC/jq69M51Z+577r3vNLdznnq7i3uej/d3nuec85xXJC5K/P3JAHIGJE4gl0DiCZAXwVwCuQQSJ5BLIPEEyLtALoFcAjNAwPYSYAuwGVgOzC88IYJvhecd8BgYkzRRdXiVlYDtVcAOYBuwvsUXGQMeAvckvW3RxrRqHQdg+yCwB9ja4YBDVoxIutpJux0DYLsXOAaE3yrlEXBBUvhtW9oGYHsecB4IMz+TEjLhpKQv7ThtC4DtlcA1YG07QbSh+wkYlBTKoyVpGYDtQ8CVSK/fw4IGvAfeAOPAL2A1EBbN8OwG5kTaPSHpXKTOn+EtAbB9Bjgd6fAlcFRSePEpxXYPcBFYGmm/X9LtSJ14ALaPA7G0L0s6EhOc7ZAp22N0wu4jaTRGJyoDbO8E7sQ4AO5LCueBaLF9CTgcqbhL0t2yOqUB2F4APAFWlDUOfJC0rH687X212d0A/ASeAc8lDTUY+wLYGOEznCR7JH0toxMDICx4YeErKz+APkkB2j+xPVJb6BrZGZe0rm78mhqguWUdA0OSBsuMLwXA9n7gehmDhTHDkgbqXuZ1iS1zVFI4SRah3QL6I/0fkHSjmU5ZACFFNzUzVvf/pK0pctsckDT8157tU8DZSP//ZVMj/aYAbIdm5kGk8zC8t3hAsX0TCLVfRiZlge2+sJiWUawbs1dSyJ4ppQyAp7VWNtb/wuIx1fZHILTFZWRC0uJCBiwCPpdRrBvzStK0nWgG0Ixq8iUQANlOdxGsAUh7G6xBSPcgVAOQ9lG4BiHdZqiwJ6fbDhcgpHshUoCQ7pVYAUK6l6IFCOleixeP0cl+GKnvJZL9NNYARJofRxt1l0l+Hm/WZs+W/5teiMyWQKuKIwOoimy32M0Z0C0zVVWcOQOqItstdnMGdMtMVRVnzoCqyHaL3ZwB3TJTVcWZM6Aqst1i9zeYIGJQFMquqwAAAABJRU5ErkJggg==",self.location).href:new URL("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAAtFJREFUeF7t2T/oVEcQwPGPnYWglWghpIoWiQpaJBKIIGgRE7TQQvwHAf+QSsQqgoKtYuc/kCSKCFooKoKCWPgPQUFEEGy0CEJSWVikCCGMvIPzeXq7d7+nnLsDjytuZ3bed2dmd/ZNU7hMK/z9VQA1AgonUFOg8ACoRbCmQE2BwgnUFCg8AOouUFOgpsDHIfAFluN7LMCsvic8eNX3PMF13MOfXbvXZQosxE/4Ad+M+CIB4Sou4fGINj6o1gWAn7EeK6fY4YiKczg5lXanEsAq7EL8dinXcBjxO7ZMBYCZOIRY+Y8pEQm/4q9xJh0XwNf4DUvGcWIM3RfY3hTNkcyMA2AbjmfO+ropaE/xCA/xHxYhimY86zA90+4eHMzUeTN8VAD7sS9zwrv4pXnxD6muwBF8mWl/A85m6owEYPcItI9hZ6ZzsfX9mKkTu8/5HJ3cCFiDCzkT4HJzHshUezP8KHZkKq7FxVSdHACzcQNfpRrHM8wfMH5Ts7rf4l/cwm2cGDD2DpZlzBknyUijv1N0cgBEwYvClyr/YHUDrV8nDjNR6AZJFMWlrT8WN4BmpE7cgIzdYaikAtiC34dae3vAaWxu6TxI2DIjhyOX++UMosjlyFb8MUwhFUCE6HfDjLX+b29NOdtmgAuAPdmLA5nzD4qmd0ykAIhm5krm5DE8jsRxfu/JKUTup0g7CiKVopjmykZE9LxXUgDcbFrZ3MnntI6pzxFtcYpEGzyvb+BcvExRbI25P6wTrQASqBafAsGo6CIYAIrfBgNC0QehAFD8UTggFN0M9TaMotvhHoSiL0R6EHLO9j2dz+ZKrPdCRV+K9iAUfS3ef5Iu9sNIu50o9tNYG0SxH0cHNZhFfh5P6LQ//ZCUC5FP72WHHlQAHcKdCNM1AiZimTp0skZAh3AnwnSNgIlYpg6drBHQIdyJMF0jYCKWqUMnawR0CHciTP8Phw+oQQpn1acAAAAASUVORK5CYII=",self.location).href:s.themeValue?new URL("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABO1JREFUeF7tmkmoHVUQhr8fQVwI6sJhkYBujIITKqIiKATNwii6iIugURSNGgRHCLhIslNU4sIx4BhESBaKEcUJRaNRNE44oC4MGHACBxAREUrqcTr0venhVPd9l0e/W9DcxTl1qv7/VNepOn3FIhctcvzMCJhFwCJnYPYKLPIAmCXBQb8CZrZR0samKB8sAQ4e2ABsaiJhkASUwBeb75GwqSoSBkdABXjH/TVwmaQvxkkYFAE14L9L4D8ddATUgP8+gf+oLhEOIgJqwP+QwL8/6FOgBvyPCfzOtkJvKhFgZkcD5wHnAscBh5aefwHfrb2lxx1/W5KP1UoN+F8T+LfawPv4vBFgZicBFwMXAmfmOFMx5+NExC3jYzXgf0/gX8+1N3ECzOwadwK4INeJhnnbJflaI1ID/q8E/uWI3YkRYGYrAN8p/52ERMD/k8DviBruTYCZHQLcB/jOT0oi4P9L4J/rYrwXAWZ2IvAEcFoX4zU6EfC+hFd427va70yAmV0HPBo07O/pC6k09cpsN3AAcFZ6lgTe+bLp9ZLuDvoyN70TATVJqM3+e8A6SZUlaZ1ywFZj11e3fpgAM7sNuLcN7dj4I5JuCOoQAF8svULSqxE7IQLM7BIgmmx2SPJ6oFI8iUr6c3ywA/hiiTMkfZhLQjYBZnYE8AZwQu7iwLeSllWA8/xxNrCn6rKiB3g39RlwviSvCFslQoAnPHc8V/xsXinJSdsnZuadmZ8ale9sT/CFncclZR3LWQSY2ZXAk7nI07ytktaMgd8GrOoAfj1wV9C+J9yH2nRyCXgHOKdtsbHxOyTtS5ZmdgXwdAfwRSns5EXEm6tlkv5uUmolwMy8mXkxYjnNHcnIZvYasLPqbq4h7OeKHDPzV6b2UqPBt5skPdCXgDdTKxvl4ChJPxdKZrahC3jXN7PDgN+iDgCfSDq1LwHvpowdtb9UkofhHABJ3qqOSMPO75W0tETekcBPUQeADyQ1tuI5r8Bq4JkOxhtr9JZsP9IPmJm31q908OFySY2+5xBwEPAVcEzQgc2Sbq3SyTjq1kjaWoqA24F7gvZ3Szq9TaeVgBTCNwIPti02Nh7t6gr1/fTMzE8PP0UicpWkp9oUsghIJDwGXN22YBrvCv5LSSOVppktT6eQR2KubJG0NmdyhIDDAT/KTm5ZOAreE+Uuf81qyuJvgGNzwKQ5/vVnuaRfcnSyCUhRsBJounaKgm9LlH53cFEOkNKcSyU9n6sTIiCRsA6oKi4mDf5h4PpcIGle+HYoTEAi4WZgc8m5iYE3s1NSwvVuMSKrJT0bUfC5nQhIJHhT4/V5FLx/9PDHCyy/EnPxUteBH5++JRwcBDLSd0R0OxNQkFB1IZlxzkd8bJq7B1gbvQUqL9iLgCrPpgjej+U7y/1GF1YnSsCUwHtJ7FVml9J4P44mRsAUwPtl5zZJvvMTk4kQ0AD+/tRKe4LrIl4gveTfEiR93mWBNp3eBLRdZhQOmJl/HvdnSenxlvdA4I/S45Wc7/auop1uA9FnvBcBueD7ODjfup0JGAL4zoXQUMB3ImBI4MMEDA18iIAhgs8mYKjgswgYMvgsAlLX5zeyfjNbSPjiYb7P867rZ9cBZrYFuLbvf3K6OjpfetkEpEhY1ecPSfMFos+6IQL6GFqoujMCFurOTMuvWQRMi+mFaud/XhkSXwnoZssAAAAASUVORK5CYII=",self.location).href:new URL("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABJ9JREFUeF7tmkuoVlUUx3+XQBwE6UBtkJCTSjALDdEIEqIcmFEDHYgvlCwVwV4QNMhmhYoOLDVQywihBoqKkg+UfJSYmVKJOTBIMA18gISIA/nLPnA4d5+z99rnfF927rfgcLnsvdba///eZz32+foY4NI3wPHTI6B3AgY4A71XYIAfgF4QbPsrsBzQUyptJkDAPwQ+qiKhrQRk4LOd1/8iop+0kYAieIE+C8wAfi0y0DYCfODPO/C/tP0E+MBfcOB/KouCbTkBPvB/OfA/tj0L+MBfcuCPhAq9bp2AR4HJwPPAE8CQ3HMb0G5dzD1a+PeAxqrEB/4fB/5QCLzGO0nAWOAVYCowMWYxnjk/OyLe8oz5wF9z4PfH+usEAQvcIl6KXUTFvG+dreIUH/ibbu4ei98mCZgCaKf0twmxgL/lwO+0Om6CgIeAVYB2vimxgL/jwG9LcV6XgCeBzcD4FOclOhbwMqEKTzpJUoeAhcAGo1e9pztcaarK7CTwADDJPY8Y3vm86/eBT4xruTc9lQBfEAr5PwYsAbwlaYVyrK/Krq/MfgoB7wArQ2gL4+uBRUYdTY8Fn5lWAN5r8WMl4FXAGmwUmVUPlImC6A3PoBV8ZmICcCKWBAsBw4EDwJhY48AfwOOe+YofzwJ/llxWpIKXq9PAi4AqwqBYCFDA08JjRbn5ZUdaXkedmbJG2TtbB3zmZ1NsWo4lYC7wRSxyN+8rYE5B5xtgegJ4RfmPjf4VcD8L6cQScBh4LmSsMP5eIVjOBrYkgFeel4g8i6i50uv3b5VSDAFqZnZZPLu5xYi8D1CX57ubKzv2WZGjV6b0UqNibUuBtXUJOOhaWSsHDwOXc0rZDW3RTgi85g8FrloXAJwCxtUl4KiL2Fb/I11/nwFQqxoLXsdX+pmMAP62LgA4HmrFY16BmcDXCc5DNXpVtC/2A2qtv0tYw6zQ2mMIGAz8DowyLmA18HaJTijVKXsoi2TyLrDC6F99xjMhnRgCZGMx8GnIWGHc2tVl6j49ZQ9lEYvMA74MKcQSIDsbgfkhg248FfxvnkrzBZeFdBJj5XPgjZjJFgKGAUplTwUMW8Er4P3gXjPfh8xzwGMxYNwcff0RaVdidCwEyJ5K26prJyv4UKDU3cG0GCC5Oa8B22N1rATIrkpMX3HRNPh1wJuxQNy8EKH9zKUQICPLAEX5qsClsZgip7iop13AVbdoEaXrrRYFzU0lQLpqalSfW3de5bAeFVhKVRKVugI+2t0dPGgEUuw7otXrEJCR4LuQDOX56AUGJuo+QdHedAuUt1mXAN/6ugVeafmDQr9hJrZpAroBXiWx4k9KadxYEPwvdl7HXDFHO9+YNHUCynZ+jWulFeBSRAXSbvct4UyKgZBOEwTEpjp9Htejjx/Zo5Z3EHA996iS024LvKrEjkpdAmLBdxREHeN1CPjfg69TCLUCfCoBrQGfQkCrwFsJaB14CwGtBB9LQGvBxxKgebqR1c1sJuaLhzq5upO6ljpAF42v1/1NTifBpNi2ECD7ugRJ/kFSygI7rWMloNPr6br9HgFdp/w+c9g7AffZhnR9OXcBC2PsQVriZsoAAAAASUVORK5CYII=",self.location).href)),checkzIndex:v((()=>{let e={zIndex:0};return s.isFullWork?e.zIndex=l.zIndex.max:e.zIndex=l.zIndex.min,e}))};let y={handleBack(){n.$router.replace("/module")},drawPixelArea(e=0,a=0){0===e&&0===a&&(e=l.canvasBeginPos.x,a=l.canvasBeginPos.y,l.canvasBeginPos.centerX=l.canvasBeginPos.x+l.scale*l.canvasWidth/2,l.canvasBeginPos.centerY=l.canvasBeginPos.y+l.scale*l.canvasHeight/2),l.drawAreaList=[],l.ctx2.clearRect(0,0,l.bgCanvas.width,l.bgCanvas.height),l.ctx2.globalAlpha=.25;for(let t=0;t<l.canvasHeight;t++)for(let r=0;r<l.canvasWidth;r++){l.ctx2.fillStyle=(t+r)%2==0?"rgba(0, 0, 0, 0.5)":"rgba(100, 100, 100, 0.5)";let n=l.scale,s=l.scale,i=r*n+e,c=t*s+a;l.ctx2.fillRect(i,c,n,s),l.drawAreaList.push([i,c])}},getCurrentLayerData:(e=l.currentFrameIndex,a=l.currentLayerIndex)=>l.drawRecord[e].layer[a].layerData,getCurrentLayerId:(e=l.currentFrameIndex,a=l.currentLayerIndex)=>l.drawRecord[e].layer[a].layerId,getCurrentFrameId:(e=l.currentFrameIndex)=>l.drawRecord[e].frameId,handleWheelEvent(e){e.preventDefault();const a=e.deltaY>0?-1:1;l.scale+=a,l.scale=Math.max(1,l.scale),l.scale>60&&(l.scale=60),y.handleResizeDraw()},handleResizeCanvas(e){l.scale+=e,l.scale=Math.max(1,l.scale),l.scale>60&&(l.scale=60),y.handleResizeDraw()},handleResizeDraw(){y.drawPixelArea(),y.reDraw(!1)},startDrawing(){l.canvas.addEventListener("mousedown",y.start),l.canvas.addEventListener("mousemove",y.draw),l.canvas.addEventListener("mouseup",y.stop),l.canvas.addEventListener("touchstart",y.mobileStart),l.canvas.addEventListener("touchmove",y.mobileDraw),l.canvas.addEventListener("touchend",y.stop),l.canvas.addEventListener("mouseout",y.leave),l.canvas.addEventListener("wheel",y.handleWheelEvent)},mobileStart(e){let a={offsetX:e.touches[0].clientX-l.canvas.getBoundingClientRect().left,offsetY:e.touches[0].clientY-l.canvas.getBoundingClientRect().top};y.start(a)},start(e){if(e.offsetX>=l.drawAreaList[0][0]&&e.offsetX<l.drawAreaList[l.drawAreaList.length-1][0]+l.scale&&e.offsetY>=l.drawAreaList[0][1]&&e.offsetY<l.drawAreaList[l.drawAreaList.length-1][1]+l.scale){y.stop();const a=Math.floor((e.offsetY-l.drawAreaList[0][1])/l.scale),t=Math.floor((e.offsetX-l.drawAreaList[0][0])/l.scale);if(l.isSpace){l.isDragging=!0;let e=t*l.scale+l.canvasBeginPos.x,r=a*l.scale+l.canvasBeginPos.y;l.dragData.x=e,l.dragData.y=r}}},draw(e){if(e.offsetX>=l.drawAreaList[0][0]&&e.offsetX<l.drawAreaList[l.drawAreaList.length-1][0]+l.scale&&e.offsetY>=l.drawAreaList[0][1]&&e.offsetY<l.drawAreaList[l.drawAreaList.length-1][1]+l.scale){const a=Math.floor((e.offsetY-l.drawAreaList[0][1])/l.scale),t=Math.floor((e.offsetX-l.drawAreaList[0][0])/l.scale);if(l.isSpace){l.canvas.style.cursor="grabbing";let e=t*l.scale+l.canvasBeginPos.x,r=a*l.scale+l.canvasBeginPos.y;y.startDrag(e,r)}}else l.canvas.classList=""},mobileDraw(e){let a={offsetX:e.touches[0].clientX-l.canvas.getBoundingClientRect().left,offsetY:e.touches[0].clientY-l.canvas.getBoundingClientRect().top};y.draw(a)},startDrag(e,a){if(l.isDragging){const t=e-l.dragData.x,r=a-l.dragData.y;let n=l.drawAreaList[0][0]+t,s=l.drawAreaList[0][1]+r,i=n+l.scale*l.canvasWidth/2,c=s+l.scale*l.canvasHeight/2;y.drawPixelArea(n,s),y.reDraw(!1,!1,{x:n,y:s,centerX:i,centerY:c})}},handleLayerImg(){let e=1;e=l.canvasWidth>l.canvasHeight?Math.floor(Math.max(1,40/l.canvasWidth)):Math.floor(Math.max(1,40/l.canvasHeight));let a=l.drawRecord[l.currentFrameIndex].layer[l.currentLayerIndex].layerData,t=0;l.realCanvas.width=l.canvasWidth*e,l.realCanvas.height=l.canvasHeight*e,l.ctx3.clearRect(0,0,l.realCanvas.width,l.realCanvas.height),l.ctx3.globalAlpha=1;for(let r=0;r<l.canvasHeight;r++)for(let n=0;n<l.canvasWidth;n++){let s=a[n+r*l.canvasWidth][2];s===l.emptyColor&&t++,l.ctx3.fillStyle=s,l.ctx3.fillRect(n*e,r*e,e,e)}t>=l.canvasHeight*l.canvasWidth?l.drawRecord[l.currentFrameIndex].layer[l.currentLayerIndex].currentLayerImg=y.handleGridImg():l.drawRecord[l.currentFrameIndex].layer[l.currentLayerIndex].currentLayerImg=l.realCanvas.toDataURL("image/png")},handleGridImg(){l.realCanvas.width=40,l.realCanvas.height=40,l.ctx3.globalAlpha=.25,l.ctx3.clearRect(0,0,l.realCanvas.width,l.realCanvas.height);for(let e=0;e<l.realCanvas.height;e++)for(let a=0;a<l.realCanvas.width;a++)l.ctx3.fillStyle=(e+a)%2==0?"rgba(0, 0, 0, 0.5)":"rgba(100, 100, 100, 0.5)",l.ctx3.fillRect(6*a,6*e,6,6);return l.realCanvas.toDataURL("image/png")},handleFrameImg(e,a=!0){let t=0;const r=l.drawRecord[l.currentFrameIndex].layer;l.realCanvas.width=5*l.canvasWidth,l.realCanvas.height=5*l.canvasHeight,l.ctx3.clearRect(0,0,l.realCanvas.width,l.realCanvas.height),l.ctx3.globalAlpha=1;for(let n=r.length-1;n>=0;n--)if(r[n].isRender)for(let e=0;e<l.canvasHeight;e++)for(let a=0;a<l.canvasWidth;a++){let s=r[n].layerData[a+e*l.canvasWidth][2];s===l.emptyColor&&t++,l.ctx3.fillStyle=s,l.ctx3.fillRect(5*a,5*e,5,5)}if(t>=l.canvasHeight*l.canvasHeight*r.length)l.drawRecord[l.currentFrameIndex].currentFrameImg="";else{let e=l.realCanvas.toDataURL("image/png");l.drawRecord[l.currentFrameIndex].currentFrameImg=e}y.handleLayerImg(),l.worker.postMessage({type:3,currentFrameData:JSON.parse(JSON.stringify(l.drawRecord[l.currentFrameIndex].layer))}),l.worker.onmessage=e=>{l.colorStatList=e.data}},reDraw(e=!0,a=!0,t=l.canvasBeginPos,r=!0){let n=0;l.ctx1.clearRect(0,0,l.canvas.width,l.canvas.height),l.drawRecord.length-1<l.currentFrameIndex&&(l.currentFrameIndex=l.drawRecord.length-1);let s=l.drawRecord[l.currentFrameIndex].layer,i=l.drawRecord[l.currentFrameIndex].layer[l.currentLayerIndex].layerId;for(let c=s.length-1;c>=0;c--)if((r||s[c].layerId!==i)&&s[c].isRender)for(let e=0;e<s[c].layerData.length;e++)if(!(s[c].layerData[e][0]>=l.canvasWidth||s[c].layerData[e][1]>=l.canvasHeight||s[c].layerData[e][0]<0||s[c].layerData[e][1]<0)&&s[c].layerData[e][2]!==l.emptyColor){let a=s[c].layerData[e][0]*l.scale+t.x,r=s[c].layerData[e][1]*l.scale+t.y;l.ctx1.fillStyle=s[c].layerData[e][2],l.ctx1.fillRect(a,r,l.scale,l.scale),n++}e&&(l.FrameTimer&&clearTimeout(l.FrameTimer),l.FrameTimer=setTimeout((()=>{n>0?y.handleFrameImg(l.ctx1,a):y.handleFrameImg(l.ctx2,a)}),300))},stop(){l.isDragging&&(l.isDragging=!1,l.canvasBeginPos.x=l.drawAreaList[0][0],l.canvasBeginPos.y=l.drawAreaList[0][1])},leave(){y.stop(),l.canvas.className=""},computeScale(){l.canvasWidth>l.canvasHeight?l.scale=Math.max(1,l.canvas.width/l.canvasWidth/2*2):l.scale=Math.max(1,l.canvas.height/l.canvasHeight/2*2),l.scale=Math.round(l.scale)-2},handleChangeLayer(e){l.currentLayerIndex=e,l.currentLayerId=y.getCurrentLayerId(),l.layerAlpha=l.drawRecord[l.currentFrameIndex].layer[l.currentLayerIndex].alpha||100,l.selectLayerList=[l.currentLayerIndex]},handleChangeLayerVisible(e){if(e<0){for(let e=0;e<l.drawRecord[l.currentFrameIndex].layer.length;e++)l.drawRecord[l.currentFrameIndex].layer[e].isRender=!l.currentFrameLayerVisible;return l.currentFrameLayerVisible=!l.currentFrameLayerVisible,void y.reDraw()}let a=l.drawRecord[l.currentFrameIndex].layer[e].isRender;l.drawRecord[l.currentFrameIndex].layer[e].isRender=!a,y.reDraw(!0,!1)},handleChangeFrame(e){l.currentFrameIndex=e,l.currentFrameId=y.getCurrentFrameId(),y.handleChangeLayer(0),y.reDraw(!0,!1)},handlekeyDownEvent(e){if(" "===e.key)return e.preventDefault(),void(l.isSpace=!0);l.canvas.className=""},handleKeyUpEvent(e){" "===e.key&&(l.isSpace=!1,l.canvas.style.cursor="")},addKeyBoardEvent(){window.addEventListener("keydown",y.handlekeyDownEvent),window.addEventListener("keyup",y.handleKeyUpEvent)},handleResizeWindowEvent(e){const a=document.querySelector(".pixelBox");l.canvas.width=null==a?void 0:a.clientWidth,l.canvas.height=null==a?void 0:a.clientHeight,l.bgCanvas.width=null==a?void 0:a.clientWidth,l.bgCanvas.height=null==a?void 0:a.clientHeight,y.computeScale(),l.canvasBeginPos.x=l.bgCanvas.width/2-l.canvasWidth*l.scale/2,l.canvasBeginPos.y=l.bgCanvas.height/2-l.canvasHeight*l.scale/2,l.canvasBeginPos.centerX=l.canvasBeginPos.x+l.scale*l.canvasWidth/2,l.canvasBeginPos.centerY=l.canvasBeginPos.y+l.scale*l.canvasHeight/2,y.drawPixelArea(),y.reDraw(!1,!1)},handleResizeWindow(){window.addEventListener("resize",y.handleResizeWindowEvent)},handleInitData(){l.currentTool=0,l.historyRecord=[],l.currentFrameIndex=0,l.currentLayerIndex=0,l.currentFrameId=0,l.currentLayerId=0,l.shapeFillColor="#000000ff",l.brushColor="#000000ff",l.isCheckedRatio=!0,l.isShowReferenceLine=!1,l.isVertical=!1,l.isHorizontal=!1,l.isCenter=!1,l.brushSize=1,l.eraserSize=1,l.widthHeightRatio=1,l.tolerance=0,l.selectType="select",l.currentDrawShape="rect",l.currentDrawTransform="hReverse",l.projectData=h(),l.pinDouMode=!1,l.pinDouDrawMode=!1,l.selectLayerList=[l.currentLayerIndex],l.pindouHighlight=null,l.pindouBrand="mard",l.isHidePindouMode=!1,l.isScaling=!1,l.scaleWhitePointPos=[],l.scaleAreaData=null,l.scaleRatio=0,l.colorStatList=[],l.layerAlpha=100,l.isHideLinmoMode=!1,l.linmoMode=!1,l.linmoPhoto=null,l.currentHistoryIndex=0},handleImportProject(){if(!l.projectData)return n.$message.error(n.$t("message.importFailed"));let e=JSON.parse(JSON.stringify(l.projectData));e.createAt=f(),e.updateAt=e.createAt,e.projectId=J.v1(),e.tip="新项目",e.isTop=0,s.saveProject(e).then((e=>{e&&n.$message.success(n.$t("message.importSucceeded")+"，请在我的项目中查看")})).catch((e=>{n.$message.error(n.$t("message.importFailed"))}))},handleDownloadProject(){if(!l.projectData)return n.$message.error(n.$t("message.downloadFailed"));let e=JSON.parse(JSON.stringify(l.projectData));p(JSON.stringify(e),"application/json",e.projectName)},handleReadProjectData(){y.handleInitData(),l.loading=!0;let e=n.$route.params.projectId;O.get(`${x()}project/${e}.json`).then((e=>{let a=e.data;y.handleProjectData(a)})).catch((e=>{y.handleProjectData(null)}))},handleProjectData(e){if(e){l.projectData.projectId=e.projectId,l.projectData.projectName=e.projectName,l.projectData.updateAt=e.updateAt,l.projectData.createAt=e.createAt,l.projectData.desc=e.desc,l.canvasWidth=Number(e.width),l.canvasHeight=Number(e.height),l.projectData.width=e.width,l.projectData.height=e.height,l.projectData.frameImg=e.frameImg,l.projectData.tip=e.tip,l.projectData.isTop=e.isTop,l.projectData.data=e.data;const a=document.querySelector(".pixelBox");l.canvas=document.getElementById("Canvas"),l.bgCanvas=document.getElementById("PixelCanvas"),l.realCanvas=document.getElementById("RealCanvas"),l.canvas.width=null==a?void 0:a.clientWidth,l.canvas.height=null==a?void 0:a.clientHeight,l.bgCanvas.width=null==a?void 0:a.clientWidth,l.bgCanvas.height=null==a?void 0:a.clientHeight,l.ctx1=l.canvas.getContext("2d"),l.ctx2=l.bgCanvas.getContext("2d"),l.ctx3=l.realCanvas.getContext("2d"),y.computeScale(),l.ctx1.lineCap="square",l.ctx1.save(),l.canvasBeginPos.x=l.bgCanvas.width/2-l.canvasWidth*l.scale/2,l.canvasBeginPos.y=l.bgCanvas.height/2-l.canvasHeight*l.scale/2,l.canvasBeginPos.centerX=l.canvasBeginPos.x+l.scale*l.canvasWidth/2,l.canvasBeginPos.centerY=l.canvasBeginPos.y+l.scale*l.canvasHeight/2,y.drawPixelArea(),y.startDrawing(),y.addKeyBoardEvent(),y.handleResizeWindow(),l.projectData.data?(l.worker.postMessage({type:4,variables:JSON.parse(JSON.stringify(e.data)),canvasWidth:l.canvasWidth}),l.worker.onmessage=e=>{try{l.drawRecord=e.data,l.drawRecord.length&&y.reDraw(),y.handleChangeLayer(l.currentLayerIndex),l.loading=!1}catch(a){n.$message.error("项目预览失败"),window.location.reload()}}):(n.$message.error("项目预览失败"),n.$router.replace("/module"))}else n.$message.error("项目异常"),n.$router.replace("/module")}};return A((()=>{l.worker=new N,y.handleReadProjectData()})),m((()=>{l.canvas.removeEventListener("mousedown",y.start),l.canvas.removeEventListener("mousemove",y.draw),l.canvas.removeEventListener("mouseup",y.stop),l.canvas.removeEventListener("touchstart",y.mobileStart),l.canvas.removeEventListener("touchmove",y.mobileDraw),l.canvas.removeEventListener("touchend",y.stop),l.canvas.removeEventListener("mouseout",y.leave),l.canvas.removeEventListener("wheel",y.handleWheelEvent),window.removeEventListener("keydown",y.handlekeyDownEvent),window.removeEventListener("keyup",y.handleKeyUpEvent),window.removeEventListener("resize",y.handleResizeWindowEvent)})),C=i(i(i({},u(l)),y),c),a(C,t({editSpaceStore:s,copyText:w}));var C}});const W=e=>(k("data-v-4664eeee"),e=e(),M(),e),K=["element-loading-text"],Q={class:"back flex-start"},V={class:"flex-end"},z={class:"flex-start flex-nowarp full-w",style:{flex:"1"}},Z={class:"pixelBox scrollbar"},G={id:"RealCanvas"},q=W((()=>F("div",{class:"text-center"},"帧",-1))),$={key:0,class:"flex-start frame-list scrollbar scrollYHidden",ref:"frameBox",id:"frame-box"},_=["onClick"],ee=["src"],ae={class:"full-h flex-nowarp flex flex-column"},te={key:0,style:{flex:"1","margin-top":"15px"},class:"full-w scrollHidden"},re=W((()=>F("h1",{class:"flex-between"},"图层面板",-1))),ne={ref:"layerBox",id:"layer-box",class:"scrollbar scrollY full-w layer-list",style:{height:"calc(100% - 50px)"}},se=["data-key","onClick"],le={class:"flex-start",style:{gap:"10px"}},ie=["onClick"],ce=["src"],oe={key:0,class:"layer-img flex-center"},de=["src"];var ge=T(X,[["render",function(e,a,t,r,n,s){const l=y("ArrowLeftBold"),i=y("el-icon"),c=y("FolderAdd"),o=y("el-tooltip"),d=y("Download"),g=y("el-header"),h=y("el-footer"),v=y("el-main"),A=y("el-divider"),m=y("el-aside"),u=y("el-container"),w=C("loading");return I((L(),D("div",{class:"container full-h",style:P(e.checkzIndex),"element-loading-text":e.loadingText,"element-loading-background":"#00000000"},[B(u,{class:"full-h flex-warp"},{default:R((()=>[B(v,{class:"flex-column-center",style:{display:"flex",padding:"0","min-width":"500px"}},{default:R((()=>[B(g,{class:"flex-between"},{default:R((()=>[F("div",Q,[B(i,{onClick:e.handleBack},{default:R((()=>[B(l)])),_:1},8,["onClick"]),F("h1",null,E(e.projectData.projectName),1)]),F("div",V,[B(o,{content:"导入项目",placement:"bottom"},{default:R((()=>[B(i,{style:{"margin-right":"25px"},onClick:e.handleImportProject},{default:R((()=>[B(c)])),_:1},8,["onClick"])])),_:1}),B(o,{content:"下载项目",placement:"bottom"},{default:R((()=>[B(i,{onClick:e.handleDownloadProject},{default:R((()=>[B(d)])),_:1},8,["onClick"])])),_:1})])])),_:1}),F("div",z,[F("div",Z,[F("canvas",{id:"PixelCanvas",width:"512",height:"512",onContextmenu:a[0]||(a[0]=e=>e.preventDefault())},null,32),F("canvas",{id:"Canvas",width:"512",height:"512",onContextmenu:a[1]||(a[1]=e=>e.preventDefault())},null,32),I(F("canvas",G,null,512),[[b,!1]])])]),B(h,{class:"flex-start"},{default:R((()=>[q,e.drawRecord.length?(L(),D("div",$,[(L(!0),D(S,null,Y(e.drawRecord,((a,t)=>(L(),D("div",{key:a.frameId,onClick:a=>e.handleChangeFrame(t),class:j(["frame-item pointer",{active:e.currentFrameIndex===t}])},[a.currentFrameImg?(L(),D("img",{key:0,draggable:"false",src:a.currentFrameImg},null,8,ee)):H("",!0)],10,_)))),128))],512)):H("",!0)])),_:1})])),_:1}),B(m,null,{default:R((()=>[F("div",ae,[e.drawRecord.length?(L(),D("div",te,[re,B(A,{"border-style":"dashed"}),F("div",ne,[(L(!0),D(S,null,Y(e.drawRecord[e.currentFrameIndex].layer,((a,t)=>(L(),D("div",{draggable:"true","data-key":a.layerId,"data-node":"LI",key:a.layerId,class:j(["layer-item flex-between pointer full-w",{active:e.currentLayerIndex===t,select:e.selectLayerList.includes(t)}]),style:{gap:"10px"},onClick:a=>e.handleChangeLayer(t)},[F("div",le,[F("div",{class:"pointer layer-pic",onClick:U((a=>e.handleChangeLayerVisible(t)),["stop"])},[F("img",{src:e.requireVisibleImg(a.isRender)},null,8,ce)],8,ie),a.currentLayerImg?(L(),D("div",oe,[F("img",{draggable:"false",src:a.currentLayerImg},null,8,de)])):H("",!0),F("div",null,E(a.layerName),1)])],10,se)))),128))],512)])):H("",!0)])])),_:1})])),_:1})],12,K)),[[w,e.loading]])}],["__scopeId","data-v-4664eeee"]]);export{ge as default};
